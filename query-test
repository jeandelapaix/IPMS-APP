SELECT 
    CD.COMP_ID AS companyId,
    CD.COMP_NAME AS companyName,
    CP.PROFILE_CODE AS profileCode,
    CPD.PROFILE_NAME AS profileName,
    CPD.APR_STRUCTURE_TYPE AS approvalStructureType,
    CPD.NUMBER_OF_APPROVERS AS noOfApprovers,
    CP.STATUS AS profileStatus,
    TO_CLOB(JSON_ARRAYAGG(
        JSON_OBJECT(
            'bankId' VALUE MR.MCES_BANK_ID,
            'accountNumber' VALUE MR.MCES_ACCOUNT_NUMBER
        ) ORDER BY MR.MCES_BANK_ID
    )) AS accountList,
    LISTAGG(DISTINCT MCPPP.ENTRY_METHOD, ', ') WITHIN GROUP(ORDER BY MCPPP.ENTRY_METHOD) AS paymentEntryMethod,
    CPD.CURRENCY,
    TIER.TIER_ID_PKREF,
    TIER.MIN_AMOUNT AS minAmount,
    TIER.MAX_AMOUNT AS maxAmount,
    LISTAGG(PANEL.PANEL_ID_PKREF || '#' || PANEL.PANEL_APPROVAL_ORDER || '#' || APP_GROUP, ',') AS panelDetails
FROM 
    MCESSERV.COMPANY_DETAILS CD
INNER JOIN 
    MCESSERV.COMP_PAYMENT_PROFILE CP ON CD.COMP_ID = CP.COMP_ID
INNER JOIN 
    MCESSERV.COMP_PAYMENT_PROFILE_DETAILS CPD ON CP.PYMT_PROF_PK = CPD.ACTIVE_PYMT_PROF_PKREF
LEFT JOIN 
    MCESSERV.COMP_RESOURCE CR ON CD.ACTIVE_COMP_PKREF = CR.ACTIVE_COMP_PKREF
LEFT JOIN 
    MCESSERV.MCES_RESOURCE MR ON CR.RESOURCE_PK = MR.RESOURCE_PK
LEFT JOIN 
    MCESSERV.COMP_PAYMENT_PROFILE_PYMTENTRY MCPPP ON CP.PYMT_PROF_PK = MCPPP.active_pymt_prof_pkref
INNER JOIN 
    MCESSERV.COMP_PAYMENT_PROFILE_TIER TIER ON CP.PYMT_PROF_PK = TIER.ACTIVE_PYMT_PROF_PKREF
INNER JOIN 
    MCESSERV.COMP_PAYMENT_PROFILE_PANEL PANEL ON PANEL.TIER_ID_PKREF = TIER.TIER_ID_PKREF
LEFT JOIN 
    (SELECT USERGRP_PK || ':' || NO_OF_APPROVAL_REQUIRED AS APP_GROUP, PANEL_ID_PKREF
     FROM MCESSERV.COMP_PAYMENT_PROFILE_PANEL_APPGRP 
     WHERE ACTIVE_PYMT_PROF_PKREF = 51007001
     GROUP BY PANEL_ID_PKREF) APP_GROUP ON PANEL.PANEL_ID_PKREF = APP_GROUP.PANEL_ID_PKREF
WHERE 
    CD.COMP_ID = :company_id
    AND CP.PROFILE_CODE = :profile_code
    AND CP.STATUS = 'ACTIVE'
GROUP BY 
    CD.COMP_ID,
    CD.COMP_NAME,
    CP.PROFILE_CODE,
    CPD.PROFILE_NAME,
    CPD.APR_STRUCTURE_TYPE,
    CPD.NUMBER_OF_APPROVERS,
    CP.STATUS,
    CPD.CURRENCY,
    TIER.TIER_ID_PKREF,
    TIER.MIN_AMOUNT,
    TIER.MAX_AMOUNT;
