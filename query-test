SELECT 
    CD.COMP_ID AS companyId,
    CD.COMP_NAME AS companyName,
    CP.PROFILE_CODE AS profileCode,
    CPD.PROFILE_NAME AS profileName,
    CPD.APR_STRUCTURE_TYPE AS approvalStructureType,
    CPD.NUMBER_OF_APPROVERS AS noOfApprovers,
    CP.STATUS AS profileStatus,
    
    -- Account List in JSON format
    TO_CLOB(JSON_ARRAYAGG(
        JSON_OBJECT(
            'accountNumber' VALUE MR.MCES_ACCOUNT_NUMBER,
            'bankId' VALUE MR.MCES_BANK_ID
        )
        ORDER BY MR.MCES_BANK_ID
    )) AS accountList,
    
    -- Payment Entry Method
    LISTAGG(DISTINCT MCPPP.ENTRY_METHOD, ', ') WITHIN GROUP (ORDER BY MCPPP.ENTRY_METHOD) AS paymentEntryMethod,

    -- Tier information with panel details in JSON format
    TO_CLOB(JSON_ARRAYAGG(
        JSON_OBJECT(
            'id' VALUE TIER.TIER_ID_PKREF,
            'minAmount' VALUE TIER.MIN_AMOUNT,
            'maxAmount' VALUE TIER.MAX_AMOUNT,
            'panel' VALUE JSON_ARRAYAGG(
                JSON_OBJECT(
                    'id' VALUE PANEL.PANEL_ID_PKREF,
                    'approvalOrder' VALUE PANEL.PANEL_APPROVAL_ORDER,
                    'group' VALUE JSON_OBJECT(
                        'id' VALUE APP_GROUP.USERGRP_PK,
                        'orderInPanel' VALUE PANEL.PANEL_APPROVAL_ORDER,
                        'approvalsRequired' VALUE APP_GROUP.NO_OF_APPROVAL_REQUIRED
                    )
                )
            )
        )
    )) AS tier
    
FROM 
    MCESSERV.COMPANY_DETAILS CD

    -- Joining with COMP_APP table
    INNER JOIN MCESSERV.COMP_APP CA 
        ON CD.ACTIVE_COMP_PKREF = CA.MCES_COMPANY

    -- Joining COMP_PAYMENT_PROFILE through COMP_APP
    INNER JOIN MCESSERV.COMP_PAYMENT_PROFILE CP 
        ON CA.CMAP_PK = CP.CMAP_PKREF

    -- Join with the payment profile details table
    INNER JOIN MCESSERV.COMP_PAYMENT_PROFILE_DETAILS CPD 
        ON CP.PYMT_PROF_PK = CPD.ACTIVE_PYMT_PROF_PKREF

    -- Left join with resources
    LEFT JOIN MCESSERV.COMP_RESOURCE CR 
        ON CA.MCES_COMPANY = CR.ACTIVE_COMP_PKREF

    -- Join with MCES_RESOURCE for account details
    LEFT JOIN MCESSERV.MCES_RESOURCE MR 
        ON CR.RESOURCE_PK = MR.RESOURCE_PK

    -- Left join to get payment entry methods
    LEFT JOIN MCESSERV.COMP_PAYMENT_PROFILE_PYMTENTRY MCPPP 
        ON CP.PYMT_PROF_PK = MCPPP.active_pymt_prof_pkref

    -- Join for tier information
    INNER JOIN MCESSERV.COMP_PAYMENT_PROFILE_TIER TIER 
        ON CP.PYMT_PROF_PK = TIER.ACTIVE_PYMT_PROF_PKREF

    -- Join for panel information within the tiers
    INNER JOIN MCESSERV.COMP_PAYMENT_PROFILE_PANEL PANEL 
        ON PANEL.TIER_ID_PKREF = TIER.TIER_ID_PKREF

    -- Join for panel group information
    LEFT JOIN MCESSERV.COMP_PAYMENT_PROFILE_PANEL_APPGRP APP_GROUP 
        ON PANEL.PANEL_ID_PKREF = APP_GROUP.PANEL_ID_PKREF

WHERE 
    CD.COMP_ID = :company_id
    AND CP.PROFILE_CODE = :profile_code
    AND CP.STATUS = 'ACTIVE'

GROUP BY 
    CD.COMP_ID, 
    CD.COMP_NAME, 
    CP.PROFILE_CODE, 
    CPD.PROFILE_NAME, 
    CPD.APR_STRUCTURE_TYPE, 
    CPD.NUMBER_OF_APPROVERS, 
    CP.STATUS, 
    TIER.TIER_ID_PKREF, 
    TIER.MIN_AMOUNT, 
    TIER.MAX_AMOUNT;
