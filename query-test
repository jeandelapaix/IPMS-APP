-- Basic Company Info query
SELECT 
    CD.COMP_ID AS companyId,
    CD.COMP_NAME AS companyName,
    CP.PROFILE_CODE AS profileCode,
    CPD.PROFILE_NAME AS profileName,
    CPD.APR_STRUCTURE_TYPE AS approvalStructureType,
    CPD.NUMBER_OF_APPROVERS AS noOfApprovers,
    CP.STATUS AS profileStatus
FROM 
    MCESSERV.COMPANY_DETAILS CD
INNER JOIN 
    MCESSERV.COMP_APP CA ON CD.ACTIVE_COMP_PKREF = CA.MCES_COMPANY
INNER JOIN 
    MCESSERV.COMP_PAYMENT_PROFILE CP ON CA.CMAP_PK = CP.CMAP_PKREF
INNER JOIN 
    MCESSERV.COMP_PAYMENT_PROFILE_DETAILS CPD ON CP.PYMT_PROF_PK = CPD.ACTIVE_PYMT_PROF_PKREF
WHERE 
    CD.COMP_ID = :company_id
    AND CP.PROFILE_CODE = :profile_code
    AND CP.STATUS = 'ACTIVE';

-- Account List Query
SELECT 
    MR.MCES_ACCOUNT_NUMBER AS accountNumber,
    MR.MCES_BANK_ID AS bankId
FROM 
    MCESSERV.COMP_APP CA
INNER JOIN 
    MCESSERV.COMP_PAYMENT_PROFILE CP ON CA.CMAP_PK = CP.CMAP_PKREF
LEFT JOIN 
    MCESSERV.COMP_RESOURCE CR ON CA.MCES_COMPANY = CR.ACTIVE_COMP_PKREF
LEFT JOIN 
    MCESSERV.MCES_RESOURCE MR ON CR.RESOURCE_PK = MR.RESOURCE_PK
WHERE 
    CA.MCES_COMPANY = (SELECT ACTIVE_COMP_PKREF FROM MCESSERV.COMPANY_DETAILS WHERE COMP_ID = :company_id)
    AND CP.PROFILE_CODE = :profile_code;

-- Payment Entry Methods Query
SELECT 
    LISTAGG(DISTINCT MCPPP.ENTRY_METHOD, ', ') WITHIN GROUP (ORDER BY MCPPP.ENTRY_METHOD) AS paymentEntryMethod
FROM 
    MCESSERV.COMP_PAYMENT_PROFILE_PYMTENTRY MCPPP
INNER JOIN 
    MCESSERV.COMP_PAYMENT_PROFILE CP ON CP.PYMT_PROF_PK = MCPPP.active_pymt_prof_pkref
WHERE 
    CP.PROFILE_CODE = :profile_code
    AND CP.CMAP_PKREF = (SELECT CA.CMAP_PK FROM MCESSERV.COMP_APP CA WHERE CA.MCES_COMPANY = (SELECT ACTIVE_COMP_PKREF FROM MCESSERV.COMPANY_DETAILS WHERE COMP_ID = :company_id))
GROUP BY 
    CP.CMAP_PKREF;

--Tier and Panel Details Query
SELECT 
    TIER.TIER_ID_PKREF AS tierId,
    TIER.MIN_AMOUNT AS minAmount,
    TIER.MAX_AMOUNT AS maxAmount,
    PANEL.PANEL_ID_PKREF AS panelId,
    PANEL.PANEL_APPROVAL_ORDER AS approvalOrder,
    APP_GROUP.USERGRP_PK AS groupId,
    APP_GROUP.NO_OF_APPROVAL_REQUIRED AS approvalsRequired
FROM 
    MCESSERV.COMP_PAYMENT_PROFILE_TIER TIER
INNER JOIN 
    MCESSERV.COMP_PAYMENT_PROFILE_PANEL PANEL ON PANEL.TIER_ID_PKREF = TIER.TIER_ID_PKREF
LEFT JOIN 
    MCESSERV.COMP_PAYMENT_PROFILE_PANEL_APPGRP APP_GROUP ON PANEL.PANEL_ID_PKREF = APP_GROUP.PANEL_ID_PKREF
INNER JOIN 
    MCESSERV.COMP_PAYMENT_PROFILE CP ON CP.PYMT_PROF_PK = TIER.ACTIVE_PYMT_PROF_PKREF
WHERE 
    CP.PROFILE_CODE = :profile_code
    AND CP.CMAP_PKREF = (SELECT CA.CMAP_PK FROM MCESSERV.COMP_APP CA WHERE CA.MCES_COMPANY = (SELECT ACTIVE_COMP_PKREF FROM MCESSERV.COMPANY_DETAILS WHERE COMP_ID = :company_id));

